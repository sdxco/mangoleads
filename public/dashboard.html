<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MangoLeads CRM - Professional Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .glass-effect {
            backdrop-filter: blur(16px);
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.18);
        }
        .tab-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white !important;
            border-radius: 8px;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        .status-queued { 
            background: linear-gradient(135deg, #fbbf24, #f59e0b); 
            color: white; 
            padding: 4px 12px; 
            border-radius: 20px; 
            font-size: 12px; 
            font-weight: 600;
        }
        .status-sent { 
            background: linear-gradient(135deg, #10b981, #059669); 
            color: white; 
            padding: 4px 12px; 
            border-radius: 20px; 
            font-size: 12px; 
            font-weight: 600;
        }
        .affiliate-card {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
            border: 1px solid rgba(102, 126, 234, 0.2);
            transition: all 0.3s ease;
        }
        .affiliate-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.15);
        }
        .commission-badge {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
        }
        .user-role-admin {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 600;
        }
        .user-role-affiliate {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 600;
        }
    </style>
</head>
<body class="min-h-screen gradient-bg">
    <!-- Header -->
    <header class="glass-effect shadow-lg sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-4">
                <div class="flex items-center space-x-4">
                    <div class="text-3xl">ðŸ¥­</div>
                    <div>
                        <h1 class="text-2xl font-bold text-gray-800">MangoLeads CRM</h1>
                        <p class="text-sm text-gray-600">Professional Lead Management System</p>
                    </div>
                </div>
                
                <!-- User Info -->
                <div class="flex items-center space-x-4">
                    <div class="text-right">
                        <div class="flex items-center space-x-2">
                            <span id="userName" class="font-medium text-gray-800"></span>
                            <span id="userRole" class="user-role-admin"></span>
                        </div>
                        <div class="text-sm text-gray-600" id="lastLogin"></div>
                    </div>
                    <div class="w-10 h-10 bg-gradient-to-r from-purple-500 to-pink-500 rounded-full flex items-center justify-center text-white font-bold">
                        <span id="userInitials"></span>
                    </div>
                    <button 
                        id="logoutBtn"
                        class="px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg transition-colors duration-200"
                    >
                        <i class="fas fa-sign-out-alt mr-2"></i>Logout
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        
        <!-- Navigation Tabs -->
        <div class="glass-effect rounded-xl p-1 mb-8 inline-flex space-x-1">
            <button class="tab-btn active px-6 py-3 rounded-lg font-medium text-gray-700 transition-all duration-200" data-tab="dashboard">
                <i class="fas fa-chart-line mr-2"></i>Dashboard
            </button>
            <button class="tab-btn px-6 py-3 rounded-lg font-medium text-gray-700 transition-all duration-200" data-tab="leads">
                <i class="fas fa-users mr-2"></i>Leads
            </button>
            <button id="affiliatesTab" class="tab-btn px-6 py-3 rounded-lg font-medium text-gray-700 transition-all duration-200 hidden" data-tab="affiliates">
                <i class="fas fa-handshake mr-2"></i>Affiliates
            </button>
            <button class="tab-btn px-6 py-3 rounded-lg font-medium text-gray-700 transition-all duration-200" data-tab="brands">
                <i class="fas fa-tags mr-2"></i>Brands
            </button>
        </div>

        <!-- Dashboard Tab -->
        <div id="dashboardTab" class="tab-content">
            <!-- Stats Cards -->
            <div id="statsGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <!-- Stats will be populated dynamically -->
            </div>

            <!-- Recent Activity -->
            <div class="glass-effect rounded-xl p-6">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">
                    <i class="fas fa-clock mr-2 text-purple-600"></i>Recent Activity
                </h2>
                <div class="space-y-3">
                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                        <div class="flex items-center space-x-3">
                            <div class="w-8 h-8 bg-green-100 rounded-full flex items-center justify-center">
                                <i class="fas fa-user-plus text-green-600 text-sm"></i>
                            </div>
                            <div>
                                <p class="font-medium text-gray-800">New lead registered</p>
                                <p class="text-sm text-gray-600">From affiliate: AFF001</p>
                            </div>
                        </div>
                        <span class="text-sm text-gray-500">2 minutes ago</span>
                    </div>
                    
                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                        <div class="flex items-center space-x-3">
                            <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center">
                                <i class="fas fa-paper-plane text-blue-600 text-sm"></i>
                            </div>
                            <div>
                                <p class="font-medium text-gray-800">Lead sent to brand</p>
                                <p class="text-sm text-gray-600">Demo Trading Platform</p>
                            </div>
                        </div>
                        <span class="text-sm text-gray-500">15 minutes ago</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Leads Tab -->
        <div id="leadsTab" class="tab-content hidden">
            <div class="glass-effect rounded-xl p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-semibold text-gray-800">
                        <i class="fas fa-users mr-2 text-purple-600"></i>Lead Management
                    </h2>
                    <button class="px-4 py-2 bg-green-500 hover:bg-green-600 text-white rounded-lg transition-colors duration-200">
                        <i class="fas fa-plus mr-2"></i>Add Lead
                    </button>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="min-w-full">
                        <thead>
                            <tr class="border-b border-gray-200">
                                <th class="text-left py-3 px-4 font-semibold text-gray-700">Name</th>
                                <th class="text-left py-3 px-4 font-semibold text-gray-700">Email</th>
                                <th class="text-left py-3 px-4 font-semibold text-gray-700">Phone</th>
                                <th class="text-left py-3 px-4 font-semibold text-gray-700">Affiliate</th>
                                <th class="text-left py-3 px-4 font-semibold text-gray-700">Commission</th>
                                <th class="text-left py-3 px-4 font-semibold text-gray-700">Status</th>
                                <th class="text-left py-3 px-4 font-semibold text-gray-700">Date</th>
                            </tr>
                        </thead>
                        <tbody id="leadsTableBody">
                            <!-- Leads will be populated dynamically -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Affiliates Tab -->
        <div id="affiliatesTab" class="tab-content hidden">
            <div class="space-y-6">
                <!-- Affiliate Stats -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="glass-effect rounded-xl p-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium text-gray-600">Total Affiliates</p>
                                <p id="totalAffiliates" class="text-2xl font-bold text-gray-900">0</p>
                            </div>
                            <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
                                <i class="fas fa-handshake text-blue-600 text-xl"></i>
                            </div>
                        </div>
                    </div>
                    
                    <div class="glass-effect rounded-xl p-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium text-gray-600">Total Commissions</p>
                                <p id="totalCommissions" class="text-2xl font-bold text-gray-900">$0</p>
                            </div>
                            <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center">
                                <i class="fas fa-dollar-sign text-green-600 text-xl"></i>
                            </div>
                        </div>
                    </div>
                    
                    <div class="glass-effect rounded-xl p-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium text-gray-600">Pending Payments</p>
                                <p id="pendingCommissions" class="text-2xl font-bold text-gray-900">$0</p>
                            </div>
                            <div class="w-12 h-12 bg-yellow-100 rounded-lg flex items-center justify-center">
                                <i class="fas fa-clock text-yellow-600 text-xl"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Affiliates List -->
                <div class="glass-effect rounded-xl p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-semibold text-gray-800">
                            <i class="fas fa-handshake mr-2 text-purple-600"></i>Affiliate Partners
                        </h2>
                        <button id="addAffiliateBtn" class="px-4 py-2 bg-green-500 hover:bg-green-600 text-white rounded-lg transition-colors duration-200">
                            <i class="fas fa-plus mr-2"></i>Add Affiliate
                        </button>
                    </div>
                    
                    <div id="affiliatesGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <!-- Affiliate cards will be populated dynamically -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Brands Tab -->
        <div id="brandsTab" class="tab-content hidden">
            <div class="glass-effect rounded-xl p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-semibold text-gray-800">
                        <i class="fas fa-tags mr-2 text-purple-600"></i>Brand Management
                    </h2>
                    <button class="px-4 py-2 bg-green-500 hover:bg-green-600 text-white rounded-lg transition-colors duration-200">
                        <i class="fas fa-plus mr-2"></i>Add Brand
                    </button>
                </div>
                
                <div id="brandsContainer">
                    <!-- Brands will be populated dynamically -->
                </div>
            </div>
        </div>
    </div>

    <!-- Add Affiliate Modal -->
    <div id="addAffiliateModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="bg-white rounded-xl p-6 w-full max-w-md mx-4">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">Add New Affiliate</h3>
            <form id="addAffiliateForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Username</label>
                    <input type="text" name="username" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                    <input type="email" name="email" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">First Name</label>
                    <input type="text" name="firstName" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Last Name</label>
                    <input type="text" name="lastName" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Company Name</label>
                    <input type="text" name="companyName" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Commission Rate (%)</label>
                    <input type="number" name="commissionRate" min="1" max="50" value="15" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                    <input type="password" name="password" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                </div>
                <div class="flex justify-end space-x-3 mt-6">
                    <button type="button" id="cancelAffiliateBtn" class="px-4 py-2 text-gray-600 border border-gray-300 rounded-lg hover:bg-gray-50">
                        Cancel
                    </button>
                    <button type="submit" class="px-4 py-2 bg-green-500 hover:bg-green-600 text-white rounded-lg">
                        Create Affiliate
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Global variables
        let currentUser = null;
        let authToken = null;

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            checkAuthentication();
            initializeEventListeners();
        });

        // Check authentication
        async function checkAuthentication() {
            authToken = localStorage.getItem('authToken');
            const userData = localStorage.getItem('userData');

            if (!authToken || !userData) {
                window.location.href = '/login.html';
                return;
            }

            try {
                const response = await fetch('/api/auth/validate', {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                const result = await response.json();

                if (!result.valid) {
                    localStorage.removeItem('authToken');
                    localStorage.removeItem('userData');
                    window.location.href = '/login.html';
                    return;
                }

                currentUser = result.user;
                setupUserInterface();
                loadDashboardData();
            } catch (error) {
                console.error('Authentication check failed:', error);
                window.location.href = '/login.html';
            }
        }

        // Setup user interface based on role
        function setupUserInterface() {
            // Update header
            document.getElementById('userName').textContent = `${currentUser.firstName} ${currentUser.lastName}`;
            document.getElementById('userRole').textContent = currentUser.role.toUpperCase();
            document.getElementById('userRole').className = `user-role-${currentUser.role}`;
            document.getElementById('userInitials').textContent = 
                `${currentUser.firstName.charAt(0)}${currentUser.lastName.charAt(0)}`;

            // Show/hide affiliate tab based on role
            if (currentUser.role === 'admin') {
                document.getElementById('affiliatesTab').classList.remove('hidden');
            }
        }

        // Initialize event listeners
        function initializeEventListeners() {
            // Tab switching
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const tabName = this.dataset.tab;
                    switchTab(tabName);
                });
            });

            // Logout
            document.getElementById('logoutBtn').addEventListener('click', logout);

            // Modal handlers
            document.getElementById('addAffiliateBtn').addEventListener('click', function() {
                document.getElementById('addAffiliateModal').classList.remove('hidden');
            });

            document.getElementById('cancelAffiliateBtn').addEventListener('click', function() {
                document.getElementById('addAffiliateModal').classList.add('hidden');
            });

            document.getElementById('addAffiliateForm').addEventListener('submit', createAffiliate);
        }

        // Switch tabs
        function switchTab(tabName) {
            // Update active button
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');

            // Show corresponding tab content
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.add('hidden'));
            document.getElementById(`${tabName}Tab`).classList.remove('hidden');

            // Load tab-specific data
            switch(tabName) {
                case 'dashboard':
                    loadDashboardData();
                    break;
                case 'leads':
                    loadLeads();
                    break;
                case 'affiliates':
                    loadAffiliates();
                    break;
                case 'brands':
                    loadBrands();
                    break;
            }
        }

        // Load dashboard data
        async function loadDashboardData() {
            try {
                const response = await fetch('/api/stats', {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                const stats = await response.json();
                
                renderStatsCards(stats);
            } catch (error) {
                console.error('Error loading dashboard data:', error);
            }
        }

        // Render stats cards
        function renderStatsCards(stats) {
            const statsGrid = document.getElementById('statsGrid');
            
            if (currentUser.role === 'admin') {
                statsGrid.innerHTML = `
                    <div class="glass-effect rounded-xl p-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium text-gray-600">Total Leads</p>
                                <p class="text-2xl font-bold text-gray-900">${stats.total || 0}</p>
                            </div>
                            <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
                                <i class="fas fa-users text-blue-600 text-xl"></i>
                            </div>
                        </div>
                    </div>
                    <div class="glass-effect rounded-xl p-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium text-gray-600">Sent Leads</p>
                                <p class="text-2xl font-bold text-gray-900">${stats.sent || 0}</p>
                            </div>
                            <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center">
                                <i class="fas fa-paper-plane text-green-600 text-xl"></i>
                            </div>
                        </div>
                    </div>
                    <div class="glass-effect rounded-xl p-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium text-gray-600">Active Affiliates</p>
                                <p class="text-2xl font-bold text-gray-900">${stats.active_affiliates || 0}</p>
                            </div>
                            <div class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center">
                                <i class="fas fa-handshake text-purple-600 text-xl"></i>
                            </div>
                        </div>
                    </div>
                    <div class="glass-effect rounded-xl p-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium text-gray-600">Total Commissions</p>
                                <p class="text-2xl font-bold text-gray-900">$${stats.total_commissions || 0}</p>
                            </div>
                            <div class="w-12 h-12 bg-yellow-100 rounded-lg flex items-center justify-center">
                                <i class="fas fa-dollar-sign text-yellow-600 text-xl"></i>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                // Affiliate dashboard
                statsGrid.innerHTML = `
                    <div class="glass-effect rounded-xl p-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium text-gray-600">Your Leads</p>
                                <p class="text-2xl font-bold text-gray-900">${stats.total || 0}</p>
                            </div>
                            <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
                                <i class="fas fa-users text-blue-600 text-xl"></i>
                            </div>
                        </div>
                    </div>
                    <div class="glass-effect rounded-xl p-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium text-gray-600">Conversions</p>
                                <p class="text-2xl font-bold text-gray-900">${stats.sent || 0}</p>
                            </div>
                            <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center">
                                <i class="fas fa-chart-line text-green-600 text-xl"></i>
                            </div>
                        </div>
                    </div>
                    <div class="glass-effect rounded-xl p-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium text-gray-600">Conversion Rate</p>
                                <p class="text-2xl font-bold text-gray-900">${stats.conversion_rate || 0}%</p>
                            </div>
                            <div class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center">
                                <i class="fas fa-percentage text-purple-600 text-xl"></i>
                            </div>
                        </div>
                    </div>
                    <div class="glass-effect rounded-xl p-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium text-gray-600">Pending Commission</p>
                                <p class="text-2xl font-bold text-gray-900">$${stats.pending_commissions || 0}</p>
                            </div>
                            <div class="w-12 h-12 bg-yellow-100 rounded-lg flex items-center justify-center">
                                <i class="fas fa-clock text-yellow-600 text-xl"></i>
                            </div>
                        </div>
                    </div>
                `;
            }
        }

        // Load leads
        async function loadLeads() {
            try {
                const response = await fetch('/api/leads', {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                const data = await response.json();
                
                renderLeadsTable(data.leads);
            } catch (error) {
                console.error('Error loading leads:', error);
            }
        }

        // Render leads table
        function renderLeadsTable(leads) {
            const tbody = document.getElementById('leadsTableBody');
            
            if (leads.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center py-8 text-gray-500">
                            <i class="fas fa-inbox text-4xl mb-4 block"></i>
                            No leads found
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = leads.map(lead => `
                <tr class="border-b border-gray-100 hover:bg-gray-50">
                    <td class="py-3 px-4">${lead.firstName} ${lead.lastName}</td>
                    <td class="py-3 px-4">${lead.email}</td>
                    <td class="py-3 px-4">${lead.phone}</td>
                    <td class="py-3 px-4">${lead.affiliateCode || 'Direct'}</td>
                    <td class="py-3 px-4">$${lead.commission || 0}</td>
                    <td class="py-3 px-4">
                        <span class="status-${lead.status}">${lead.status}</span>
                    </td>
                    <td class="py-3 px-4">${new Date(lead.created_at).toLocaleDateString()}</td>
                </tr>
            `).join('');
        }

        // Load affiliates (admin only)
        async function loadAffiliates() {
            if (currentUser.role !== 'admin') return;

            try {
                const response = await fetch('/api/affiliates', {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                const data = await response.json();
                
                renderAffiliates(data.affiliates);
            } catch (error) {
                console.error('Error loading affiliates:', error);
            }
        }

        // Render affiliates
        function renderAffiliates(affiliates) {
            const grid = document.getElementById('affiliatesGrid');
            
            // Update stats
            document.getElementById('totalAffiliates').textContent = affiliates.length;
            document.getElementById('totalCommissions').textContent = 
                '$' + affiliates.reduce((sum, aff) => sum + aff.totalCommissions, 0).toFixed(2);
            document.getElementById('pendingCommissions').textContent = 
                '$' + affiliates.reduce((sum, aff) => sum + aff.pendingCommissions, 0).toFixed(2);

            if (affiliates.length === 0) {
                grid.innerHTML = `
                    <div class="col-span-full text-center py-8 text-gray-500">
                        <i class="fas fa-handshake text-4xl mb-4 block"></i>
                        No affiliates found
                    </div>
                `;
                return;
            }

            grid.innerHTML = affiliates.map(affiliate => `
                <div class="affiliate-card rounded-xl p-6">
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center space-x-3">
                            <div class="w-12 h-12 bg-gradient-to-r from-purple-500 to-pink-500 rounded-full flex items-center justify-center text-white font-bold">
                                ${affiliate.firstName.charAt(0)}${affiliate.lastName.charAt(0)}
                            </div>
                            <div>
                                <h3 class="font-semibold text-gray-800">${affiliate.firstName} ${affiliate.lastName}</h3>
                                <p class="text-sm text-gray-600">${affiliate.affiliateCode}</p>
                            </div>
                        </div>
                        <div class="flex items-center space-x-2">
                            <span class="${affiliate.isActive ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'} px-2 py-1 rounded-full text-xs font-medium">
                                ${affiliate.isActive ? 'Active' : 'Inactive'}
                            </span>
                        </div>
                    </div>
                    
                    <div class="space-y-2 mb-4">
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-600">Total Leads:</span>
                            <span class="font-medium">${affiliate.totalLeads}</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-600">Conversions:</span>
                            <span class="font-medium">${affiliate.convertedLeads}</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-600">Conversion Rate:</span>
                            <span class="font-medium">${affiliate.conversionRate}%</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-600">Commission Rate:</span>
                            <span class="font-medium">${affiliate.commissionRate}%</span>
                        </div>
                    </div>
                    
                    <div class="border-t pt-4">
                        <div class="flex justify-between items-center">
                            <div>
                                <p class="text-xs text-gray-600">Pending Commission</p>
                                <p class="commission-badge">$${affiliate.pendingCommissions.toFixed(2)}</p>
                            </div>
                            <button 
                                onclick="toggleAffiliateStatus('${affiliate.id}', ${!affiliate.isActive})"
                                class="px-3 py-1 text-xs ${affiliate.isActive ? 'bg-red-100 text-red-700 hover:bg-red-200' : 'bg-green-100 text-green-700 hover:bg-green-200'} rounded-lg transition-colors"
                            >
                                ${affiliate.isActive ? 'Deactivate' : 'Activate'}
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Toggle affiliate status
        async function toggleAffiliateStatus(affiliateId, newStatus) {
            try {
                const response = await fetch(`/api/affiliates/${affiliateId}/toggle`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ isActive: newStatus })
                });

                if (response.ok) {
                    loadAffiliates(); // Reload the list
                }
            } catch (error) {
                console.error('Error toggling affiliate status:', error);
            }
        }

        // Create new affiliate
        async function createAffiliate(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const affiliateData = {
                username: formData.get('username'),
                email: formData.get('email'),
                firstName: formData.get('firstName'),
                lastName: formData.get('lastName'),
                companyName: formData.get('companyName'),
                commissionRate: parseInt(formData.get('commissionRate')),
                password: formData.get('password'),
                affiliateCode: `AFF${Date.now().toString().slice(-3)}`
            };

            try {
                const response = await fetch('/api/affiliates', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(affiliateData)
                });

                const result = await response.json();

                if (result.success) {
                    document.getElementById('addAffiliateModal').classList.add('hidden');
                    e.target.reset();
                    loadAffiliates();
                } else {
                    alert('Error creating affiliate: ' + result.message);
                }
            } catch (error) {
                console.error('Error creating affiliate:', error);
                alert('Error creating affiliate');
            }
        }

        // Load brands
        async function loadBrands() {
            try {
                const response = await fetch('/api/brands', {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                const brands = await response.json();
                
                renderBrands(brands);
            } catch (error) {
                console.error('Error loading brands:', error);
            }
        }

        // Render brands
        function renderBrands(brands) {
            const container = document.getElementById('brandsContainer');
            
            container.innerHTML = brands.map(brand => `
                <div class="bg-white rounded-lg border border-gray-200 p-6 mb-4">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-4">
                            <div class="w-12 h-12 bg-gradient-to-r from-blue-500 to-purple-500 rounded-lg flex items-center justify-center text-white text-xl">
                                <i class="fas fa-building"></i>
                            </div>
                            <div>
                                <h3 class="text-lg font-semibold text-gray-800">${brand.name}</h3>
                                <p class="text-sm text-gray-600">${brand.description}</p>
                            </div>
                        </div>
                        <div class="flex items-center space-x-3">
                            <span class="${brand.active ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'} px-3 py-1 rounded-full text-sm font-medium">
                                ${brand.active ? 'Active' : 'Inactive'}
                            </span>
                            <button class="px-4 py-2 ${brand.active ? 'bg-red-500 hover:bg-red-600' : 'bg-green-500 hover:bg-green-600'} text-white rounded-lg transition-colors text-sm">
                                ${brand.active ? 'Deactivate' : 'Activate'}
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Logout
        async function logout() {
            try {
                await fetch('/api/auth/logout', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
            } catch (error) {
                console.error('Logout error:', error);
            }

            localStorage.removeItem('authToken');
            localStorage.removeItem('userData');
            window.location.href = '/login.html';
        }
    </script>
</body>
</html>
